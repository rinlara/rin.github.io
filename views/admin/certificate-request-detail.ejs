<!-- views/admin/certificate-request-detail.ejs -->
<%- include('../partials/header.ejs') %>

<style>
  .bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  
  .bg-gradient-success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
  }
  
  .bg-gradient-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }
  
  .bg-gradient-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }
  
  .bg-gradient-danger {
    background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
  }
  
  .certificate-card {
    transition: all 0.3s ease;
    border: 2px solid #e9ecef;
    border-radius: 12px;
  }
  
  .certificate-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    border-color: #667eea;
  }
  
  .number-badge {
    font-size: 1rem;
    font-weight: bold;
    padding: 6px 12px;
    border-radius: 6px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  }
  
  .status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
  }
  
  .action-btn {
    transition: all 0.2s ease;
  }
  
  .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
</style>

<!-- Header -->
<div class="container-fluid px-4 py-4">
  <div class="card shadow-lg border-0 mb-4">
    <div class="card-header bg-gradient-primary text-white py-4">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h3 class="mb-1 fw-bold">
            <i class="fas fa-info-circle me-2"></i>
            รายละเอียดคำขอหมายเลขเกียรติบัตร
          </h3>
          <p class="mb-0 opacity-75">
            <i class="fas fa-hashtag me-2"></i>
            รหัสคำขอ: <strong>#<%= request.id %></strong>
          </p>
        </div>
        <a href="/admin/certificate-requests" class="btn btn-light btn-lg">
          <i class="fas fa-arrow-left me-2"></i>
          ย้อนกลับ
        </a>
      </div>
    </div>
  </div>

  <!-- Request Information -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-gradient-info text-white py-3">
          <h6 class="mb-0 fw-bold">
            <i class="fas fa-file-alt me-2"></i>ข้อมูลคำขอ
          </h6>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-4">
              <p class="text-muted mb-1"><strong>ชื่อโครงการ/กิจกรรม:</strong></p>
              <p class="fw-bold text-dark"><%= request.event_name %></p>
            </div>
            <div class="col-md-4">
              <p class="text-muted mb-1"><strong>วันที่ขอ:</strong></p>
              <p class="fw-bold text-dark"><%= new Date(request.request_date).toLocaleDateString('th-TH') %></p>
            </div>
            <div class="col-md-4">
              <p class="text-muted mb-1"><strong>วันที่จัดกิจกรรม:</strong></p>
              <p class="fw-bold text-dark"><%= new Date(request.event_date).toLocaleDateString('th-TH') %></p>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <p class="text-muted mb-1"><strong>ชื่อคนขอ:</strong></p>
              <p class="fw-bold text-dark"><%= request.requester_name %></p>
            </div>
            <div class="col-md-6">
              <p class="text-muted mb-1"><strong>ชื่อเจ้าของลายเซ็น:</strong></p>
              <p class="fw-bold text-dark"><%= request.signature_owner %></p>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-4">
              <p class="text-muted mb-1"><strong>จำนวนที่ขอ:</strong></p>
              <p class="fw-bold text-dark"><%= request.certificate_count %> หมายเลข</p>
            </div>
            <div class="col-md-4">
              <p class="text-muted mb-1"><strong>สถานะ:</strong></p>
              <% if (request.status === 'pending') { %>
                <span class="badge bg-warning text-dark fs-6">
                  <i class="fas fa-clock me-1"></i>
                  รอตรวจสอบ
                </span>
              <% } else if (request.status === 'approved') { %>
                <span class="badge bg-success fs-6">
                  <i class="fas fa-check-circle me-1"></i>
                  อนุมัติแล้ว
                </span>
              <% } else if (request.status === 'rejected') { %>
                <span class="badge bg-danger fs-6">
                  <i class="fas fa-times-circle me-1"></i>
                  ไม่อนุมัติ
                </span>
              <% } %>
            </div>
            <div class="col-md-4">
              <p class="text-muted mb-1"><strong>วันที่สร้าง:</strong></p>
              <p class="fw-bold text-dark">
                <%= new Date(request.created_at).toLocaleDateString('th-TH') %>
                <small class="text-muted"><%= new Date(request.created_at).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) %></small>
              </p>
            </div>
          </div>
          
          <% if (request.description) { %>
            <div class="row">
              <div class="col-md-12">
                <p class="text-muted mb-1"><strong>รายละเอียดเพิ่มเติม:</strong></p>
                <p class="text-muted"><%= request.description %></p>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-gradient-success text-white py-3">
          <h6 class="mb-0 fw-bold">
            <i class="fas fa-user me-2"></i>ข้อมูลผู้ขอ
          </h6>
        </div>
        <div class="card-body">
          <div class="text-center mb-3">
            <% if (request.profile_image) { %>
              <img src="<%= request.profile_image %>" alt="Profile" class="rounded-circle mb-3" width="100" height="100" style="object-fit: cover;">
            <% } else { %>
              <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mb-3" style="width: 100px; height: 100px;">
                <i class="fas fa-user fa-3x text-muted"></i>
              </div>
            <% } %>
            <h5 class="fw-bold"><%= request.full_name %></h5>
            <p class="text-muted mb-1"><%= request.email %></p>
          </div>
          
          <div class="mb-3">
            <p class="text-muted mb-1"><strong>โรงเรียน:</strong></p>
            <p class="fw-bold text-dark"><%= request.school_name %></p>
          </div>
          
          <div class="mb-3">
            <p class="text-muted mb-1"><strong>ตำแหน่ง:</strong></p>
            <p class="fw-bold text-dark"><%= request.position_or_subject %></p>
          </div>
          
          <div class="mb-3">
            <p class="text-muted mb-1"><strong>ประเภทผู้ใช้:</strong></p>
            <span class="badge bg-primary">
              <%= request.user_type === 'teacher' ? 'ครู' : 'บุคลากร' %>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <% if (request.status === 'pending') { %>
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="alert alert-warning border-0 shadow-sm">
          <h6 class="alert-heading fw-bold">
            <i class="fas fa-exclamation-triangle me-2"></i>คำขอรอการตรวจสอบ
          </h6>
          <hr class="my-2">
          <div class="d-flex gap-2 justify-content-center">
            <button onclick="approveRequest(<%= request.id %>)" class="btn btn-success btn-lg action-btn shadow-sm">
              <i class="fas fa-check-circle me-2"></i>
              <strong>อนุมัติคำขอ</strong>
            </button>
            <button onclick="rejectRequest(<%= request.id %>)" class="btn btn-danger btn-lg action-btn shadow-sm">
              <i class="fas fa-times-circle me-2"></i>
              <strong>ปฏิเสธคำขอ</strong>
            </button>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Certificates List -->
  <% if (request.status === 'approved' && certificates.length > 0) { %>
    <div class="card shadow-lg border-0 mb-4">
      <div class="card-header bg-gradient-primary text-white py-3">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0 fw-bold">
            <i class="fas fa-certificate me-2"></i>หมายเลขเกียรติบัตรที่สร้าง (<%= certificates.length %> หมายเลข)
          </h6>
          <div class="d-flex gap-2">
            <button onclick="copyAllNumbers()" class="btn btn-success btn-sm">
              <i class="fas fa-copy me-1"></i>
              คัดลอกทั้งหมด
            </button>
            <a href="/certificates/<%= request.id %>" class="btn btn-info btn-sm">
              <i class="fas fa-eye me-1"></i>
              ดูแบบเต็ม
            </a>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <% for (var i = 0; i < certificates.length; i++) { 
             var cert = certificates[i];
          %>
            <div class="col-md-4 col-lg-3 mb-3">
              <div class="card certificate-card shadow-sm h-100">
                <div class="card-body p-3 text-center">
                  <div class="mb-2">
                    <span class="text-muted small">
                      #<%= cert.sequence_number %>
                    </span>
                  </div>
                  
                  <div class="number-badge bg-white text-dark w-100 text-center py-2 fs-5">
                    <%= cert.certificate_number %>
                  </div>
                  
                  <div class="mt-2">
                    <% if (cert.used) { %>
                      <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>
                        ใช้แล้ว
                      </span>
                    <% } else { %>
                      <span class="badge bg-warning text-dark">
                        <i class="fas fa-clock me-1"></i>
                        ยังไม่ได้ใช้
                      </span>
                    <% } %>
                  </div>
                  
                  <% if (cert.used && cert.recipient_name) { %>
                    <div class="mt-2 small text-muted">
                      <i class="fas fa-user me-1"></i>
                      <%= cert.recipient_name %>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  <% } else if (request.status === 'approved' && certificates.length === 0) { %>
    <div class="alert alert-info border-0 shadow-sm">
      <i class="fas fa-info-circle me-2"></i>
      ยังไม่มีการสร้างหมายเลขเกียรติบัตรสำหรับคำขอนี้
    </div>
  <% } %>

  <!-- Statistics -->
  <% if (certificates.length > 0) { %>
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card shadow-lg border-0">
          <div class="card-header bg-gradient-info text-white py-3">
            <h6 class="mb-0 fw-bold">
              <i class="fas fa-chart-pie me-2"></i>สถิติการใช้งาน
            </h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 text-center mb-3 mb-md-0">
                <div class="display-6 fw-bold text-primary">
                  <%= certificates.length %>
                </div>
                <small class="text-muted">จำนวนทั้งหมด</small>
              </div>
              <div class="col-md-4 text-center mb-3 mb-md-0">
                <div class="display-6 fw-bold text-success">
                  <% var usedCount = 0;
                     for (var i = 0; i < certificates.length; i++) {
                       if (certificates[i].used) usedCount++;
                     }
                  %>
                  <%= usedCount %>
                </div>
                <small class="text-muted">ใช้แล้ว</small>
              </div>
              <div class="col-md-4 text-center">
                <div class="display-6 fw-bold text-warning">
                  <%= certificates.length - usedCount %>
                </div>
                <small class="text-muted">ยังไม่ได้ใช้</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% } %>
</div>

<%- include('../partials/footer') %>

<script>
  // อนุมัติคำขอ
  function approveRequest(requestId) {
    if (!confirm('คุณแน่ใจว่าต้องการอนุมัติคำขอนี้?')) {
      return;
    }
    
    fetch('/admin/approve-request/' + requestId, {
      method: 'POST'
    })
    .then(function(response) {
      return response.json();
    })
    .then(function(data) {
      if (data.success) {
        alert('✓ ' + data.message);
        location.reload();
      } else {
        alert('✗ ' + data.message);
      }
    })
    .catch(function(error) {
      alert('เกิดข้อผิดพลาด: ' + error.message);
    });
  }

  // ปฏิเสธคำขอ
  function rejectRequest(requestId) {
    if (!confirm('คุณแน่ใจว่าต้องการปฏิเสธคำขอนี้?')) {
      return;
    }
    
    fetch('/admin/reject-request/' + requestId, {
      method: 'POST'
    })
    .then(function(response) {
      return response.json();
    })
    .then(function(data) {
      if (data.success) {
        alert('✓ ' + data.message);
        window.location.href = '/admin/certificate-requests';
      } else {
        alert('✗ ' + data.message);
      }
    })
    .catch(function(error) {
      alert('เกิดข้อผิดพลาด: ' + error.message);
    });
  }

  // คัดลอกหมายเลขทั้งหมด
  function copyAllNumbers() {
    var allNumbers = '';
    var certs = <%= JSON.stringify(certificates) %>;
    
    for (var i = 0; i < certs.length; i++) {
      allNumbers += certs[i].certificate_number + '\n';
    }
    
    navigator.clipboard.writeText(allNumbers).then(function() {
      alert('คัดลอกหมายเลขทั้งหมดเรียบร้อยแล้ว!');
    }).catch(function(err) {
      alert('เกิดข้อผิดพลาดในการคัดลอก');
    });
  }
</script>