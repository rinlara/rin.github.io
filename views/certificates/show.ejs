<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>หมายเลขเกียรติบัตร</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    .bg-gradient-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .bg-gradient-success {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
    }
    
    .bg-gradient-info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .bg-gradient-warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .certificate-card {
      transition: all 0.3s ease;
      border: 2px solid #e9ecef;
      border-radius: 12px;
    }
    
    .certificate-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      border-color: #667eea;
    }
    
    .number-badge {
      font-size: 1.1rem;
      font-weight: bold;
      padding: 8px 16px;
      border-radius: 8px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
    }
    
    .btn-copy {
      transition: all 0.2s ease;
    }
    
    .btn-copy:hover {
      transform: scale(1.05);
    }
    
    .btn-copy:active {
      transform: scale(0.95);
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 300px;
    }
    
    /* Font Awesome Icons - Inline */
    .fa {
      display: inline-block;
      font-style: normal;
      font-variant: normal;
      text-rendering: auto;
      -webkit-font-smoothing: antialiased;
    }
    
    .fa-certificate::before { content: "\f0a3"; }
    .fa-info-circle::before { content: "\f05a"; }
    .fa-calendar::before { content: "\f073"; }
    .fa-user::before { content: "\f007"; }
    .fa-copy::before { content: "\f0c5"; }
    .fa-print::before { content: "\f02f"; }
    .fa-arrow-left::before { content: "\f060"; }
    .fa-lightbulb::before { content: "\f0eb"; }
    .fa-hashtag::before { content: "\f292"; }
    .fa-check-circle::before { content: "\f058"; }
    .fa-clock::before { content: "\f017"; }
    .fa-check::before { content: "\f00c"; }
    .fa-user-check::before { content: "\f4fc"; }
    .fa-calendar-check::before { content: "\f274"; }
    .fa-chart-pie::before { content: "\f200"; }
    .fa-home::before { content: "\f015"; }
    .fa-file-alt::before { content: "\f15c"; }
    .fa-user-cog::before { content: "\f4fe"; }
    .fa-sign-out-alt::before { content: "\f2f5"; }
    .fa-copyright::before { content: "\f1f9"; }
    .fa-exclamation-triangle::before { content: "\f071"; }
    .fa-times-circle::before { content: "\f057"; }
    .fa-eye::before { content: "\f06e"; }
    .fa-spinner::before { content: "\f110"; }
  </style>
</head>
<body data-user-fullname="<%= user.full_name %>" data-user-school="<%= user.school_name %>">

  <div class="container-fluid px-4 py-4">
    <div class="card shadow-lg border-0 mb-4">
      <div class="card-header bg-gradient-primary text-white py-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h3 class="mb-1 fw-bold">
              <span class="fa fa-certificate me-2"></span>
              หมายเลขเกียรติบัตร
            </h3>
            <p class="mb-0 opacity-75">
              <span class="fa fa-info-circle me-2"></span>
              โครงการ: <strong id="eventName"><%= request.event_name %></strong>
            </p>
          </div>
          <div class="d-flex gap-2">
            <span class="badge bg-light text-dark">
              <span class="fa fa-calendar me-1"></span>
              <span id="eventDate"></span>
            </span>
            <span class="badge bg-light text-dark">
              <span class="fa fa-user me-1"></span>
              <span id="signatureOwner"><%= request.signature_owner %></span>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="d-flex gap-2 justify-content-end mb-3">
         
          <a href="/request-certificate" class="btn btn-secondary btn-lg shadow-sm">
            <span class="fa fa-arrow-left me-2"></span>
            <strong>ย้อนกลับ</strong>
          </a>
        </div>
        
        <div class="alert alert-info border-0 shadow-sm">
          <h6 class="alert-heading fw-bold">
            <span class="fa fa-lightbulb me-2"></span>คำแนะนำ
          </h6>
          <hr class="my-2">
          <ul class="mb-0 ps-3">
            <li class="mb-2">คลิกปุ่ม <strong class="text-success"><span class="fa fa-copy me-1"></span>คัดลอก</strong> เพื่อคัดลอกหมายเลขแต่ละรายการ</li>
            <li class="mb-2">คลิกปุ่ม <strong class="text-success"><span class="fa fa-copy me-1"></span>คัดลอกทั้งหมด</strong> เพื่อคัดลอกหมายเลขทั้งหมดในครั้งเดียว</li>
            <li class="mb-2">สถานะ <span class="badge bg-warning text-dark"><span class="fa fa-clock me-1"></span>ยังไม่ได้ใช้</span> หมายถึง หมายเลขยังไม่ถูกนำไปใช้งาน</li>
            <li>สถานะ <span class="badge bg-success"><span class="fa fa-check-circle me-1"></span>ใช้แล้ว</span> หมายถึง หมายเลขถูกนำไปใช้งานแล้ว</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Certificates Grid -->
    <div class="row" id="certificatesContainer">
      <!-- รายการจะถูกสร้างโดย JavaScript -->
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card shadow-lg border-0">
          <div class="card-header bg-gradient-info text-white py-3">
            <h6 class="mb-0 fw-bold">
              <span class="fa fa-chart-pie me-2"></span>สถิติการใช้งาน
            </h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 text-center mb-3 mb-md-0">
                <div class="display-6 fw-bold text-primary" id="totalCount">
                  <%= certificates.length %>
                </div>
                <small class="text-muted">จำนวนทั้งหมด</small>
              </div>
              <div class="col-md-4 text-center mb-3 mb-md-0">
                <div class="display-6 fw-bold text-success" id="usedCount">
                  0
                </div>
                <small class="text-muted">ใช้แล้ว</small>
              </div>
              <div class="col-md-4 text-center">
                <div class="display-6 fw-bold text-warning" id="unusedCount">
                  <%= certificates.length %>
                </div>
                <small class="text-muted">ยังไม่ได้ใช้</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" id="toastNotification">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">
        คัดลอกเรียบร้อยแล้ว!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- ซ่อนข้อมูลไว้ใน div -->
  <div id="requestData" style="display:none;">
    <span class="event-date"><%= request.event_date %></span>
  </div>
  <div id="certificatesData" style="display:none;"><%= JSON.stringify(certificates) %></div>
  
  <script>
    // ========== ตัวแปรข้อมูล ==========
    var userData = {
      fullName: document.body.getAttribute('data-user-fullname'),
      schoolName: document.body.getAttribute('data-user-school')
    };
    
    var requestData = {
      eventDate: document.querySelector('#requestData .event-date').textContent
    };
    
    var certificatesData = JSON.parse(document.getElementById('certificatesData').textContent);
    
    // ========== ฟังก์ชันเริ่มต้น ==========
    document.addEventListener('DOMContentLoaded', function() {
      // แสดงวันที่
      var eventDate = new Date(requestData.eventDate);
      document.getElementById('eventDate').textContent = eventDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
      
      // สร้างรายการหมายเลขเกียรติบัตร
      renderCertificates();
      
      // คำนวณสถิติ
      calculateStats();
    });
    
    // ========== ฟังก์ชันสร้างรายการ ==========
    function renderCertificates() {
      var container = document.getElementById('certificatesContainer');
      var html = '';
      
      for (var i = 0; i < certificatesData.length; i++) {
        var cert = certificatesData[i];
        var index = i;
        
        var statusClass = cert.used ? 'bg-success' : 'bg-warning text-dark';
        var statusIcon = cert.used ? 'fa-check-circle' : 'fa-clock';
        var statusText = cert.used ? 'ใช้แล้ว' : 'ยังไม่ได้ใช้';
        
        var recipientName = cert.recipient_name || cert.used_by || '-';
        var issuedDate = '-';
        if (cert.issued_date) {
          var date = new Date(cert.issued_date);
          issuedDate = date.toLocaleDateString('th-TH');
        }
        
        html += '<div class="col-md-6 col-lg-4 mb-3">';
        html += '  <div class="card certificate-card shadow-sm h-100">';
        html += '    <div class="card-body p-4">';
        html += '      <div class="d-flex justify-content-between align-items-start mb-3">';
        html += '        <div>';
        html += '          <span class="text-muted small">';
        html += '            <span class="fa fa-hashtag me-1"></span>';
        html += '            รายการที่ ' + (index + 1);
        html += '          </span>';
        html += '        </div>';
        html += '        <span class="' + statusClass + ' status-badge">';
        html += '          <span class="fa ' + statusIcon + ' me-1"></span>';
        html += '          ' + statusText;
        html += '        </span>';
        html += '      </div>';
        
        html += '      <div class="mb-4">';
        html += '        <div class="number-badge bg-white text-dark w-100 text-center py-3 fs-3">';
        html += '          ' + cert.certificate_number;
        html += '        </div>';
        html += '      </div>';
        
        html += '      <div class="d-flex gap-2">';
        html += '        <button onclick="copyNumber(\'' + cert.certificate_number + '\')" class="btn btn-success btn-copy flex-grow-1" title="คัดลอกหมายเลข">';
        html += '          <span class="fa fa-copy me-1"></span> คัดลอก';
        html += '        </button>';
        
        if (!cert.used) {
          html += '        <button onclick="markAsUsed(' + cert.id + ', \'' + cert.certificate_number + '\')" class="btn btn-primary flex-grow-1" title="ทำเครื่องหมายว่าใช้แล้ว">';
          html += '          <span class="fa fa-check me-1"></span> ใช้แล้ว';
          html += '        </button>';
        }
        
        html += '      </div>';
        
        if (cert.used) {
          html += '      <div class="mt-3 pt-3 border-top">';
          html += '        <small class="text-muted">';
          html += '          <span class="fa fa-user-check me-1"></span>';
          html += '          ใช้โดย: ' + recipientName;
          html += '        </small><br>';
          html += '        <small class="text-muted">';
          html += '          <span class="fa fa-calendar-check me-1"></span>';
          html += '          วันที่ใช้: ' + issuedDate;
          html += '        </small>';
          html += '      </div>';
        }
        
        html += '    </div>';
        html += '  </div>';
        html += '</div>';
      }
      
      container.innerHTML = html;
    }
    
    // ========== ฟังก์ชันคำนวณสถิติ ==========
    function calculateStats() {
      var usedCount = 0;
      for (var i = 0; i < certificatesData.length; i++) {
        if (certificatesData[i].used) {
          usedCount++;
        }
      }
      
      var unusedCount = certificatesData.length - usedCount;
      
      document.getElementById('usedCount').textContent = usedCount;
      document.getElementById('unusedCount').textContent = unusedCount;
    }
    
    // ========== ฟังก์ชันคัดลอกหมายเลขเดียว ==========
    function copyNumber(number) {
      navigator.clipboard.writeText(number).then(function() {
        showToast('คัดลอกหมายเลข "' + number + '" เรียบร้อยแล้ว!', 'success');
      }).catch(function(err) {
        showToast('เกิดข้อผิดพลาดในการคัดลอก', 'danger');
        console.error('เกิดข้อผิดพลาดในการคัดลอก:', err);
      });
    }

    // ========== ฟังก์ชันคัดลอกหมายเลขทั้งหมด ==========
    function copyAllNumbers() {
      var allNumbers = '';
      
      for (var i = 0; i < certificatesData.length; i++) {
        allNumbers += certificatesData[i].certificate_number + '\n';
      }
      
      navigator.clipboard.writeText(allNumbers).then(function() {
        showToast('คัดลอกหมายเลขทั้งหมดเรียบร้อยแล้ว!', 'success');
      }).catch(function(err) {
        showToast('เกิดข้อผิดพลาดในการคัดลอก', 'danger');
        console.error('เกิดข้อผิดพลาดในการคัดลอก:', err);
      });
    }

    // ========== ฟังก์ชันพิมพ์ใบรับรอง ==========
    function printCertificate() {
      window.print();
    }

    // ========== ฟังก์ชันทำเครื่องหมายว่าใช้แล้ว ==========
    function markAsUsed(certificateId, certificateNumber) {
      var recipientName = prompt('กรุณาระบุชื่อผู้รับเกียรติบัตร:', '');
      
      if (!recipientName || recipientName.trim() === '') {
        showToast('กรุณาระบุชื่อผู้รับเกียรติบัตร', 'warning');
        return;
      }
      
      if (!confirm('ต้องการทำเครื่องหมายว่าหมายเลข "' + certificateNumber + '" ถูกใช้งานแล้วหรือไม่?')) {
        return;
      }
      
      fetch('/certificates/' + certificateId + '/mark-used', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          used_by: userData.fullName,
          recipient_name: recipientName,
          recipient_school: userData.schoolName
        })
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        if (data.success) {
          showToast('ทำเครื่องหมายว่าใช้แล้วเรียบร้อย!', 'success');
          setTimeout(function() {
            location.reload();
          }, 1000);
        } else {
          showToast('เกิดข้อผิดพลาด: ' + (data.message || 'ไม่สามารถทำเครื่องหมายได้'), 'danger');
        }
      })
      .catch(function(err) {
        showToast('เกิดข้อผิดพลาด: ' + err.message, 'danger');
        console.error('Error:', err);
      });
    }

    // ========== ฟังก์ชันแสดงการแจ้งเตือน ==========
    function showToast(message, type) {
      var toastEl = document.getElementById('toastNotification');
      var toastBody = document.getElementById('toastMessage');
      
      toastBody.textContent = message;
      toastEl.className = 'toast align-items-center text-white border-0';
      
      if (type === 'success') {
        toastEl.classList.add('bg-success');
      } else if (type === 'danger') {
        toastEl.classList.add('bg-danger');
      } else if (type === 'warning') {
        toastEl.classList.add('bg-warning');
      } else if (type === 'info') {
        toastEl.classList.add('bg-info');
      }
      
      var toast = new bootstrap.Toast(toastEl);
      toast.show();
    }

    // ========== ตั้งค่าการพิมพ์ ==========
    window.addEventListener('beforeprint', function() {
      var buttons = document.querySelectorAll('.btn');
      for (var i = 0; i < buttons.length; i++) {
        buttons[i].style.display = 'none';
      }
    });

    window.addEventListener('afterprint', function() {
      var buttons = document.querySelectorAll('.btn');
      for (var i = 0; i < buttons.length; i++) {
        buttons[i].style.display = '';
      }
    });
  </script>

  <style media="print">
    body {
      background: white !important;
    }
    
    .card {
      border: none !important;
      box-shadow: none !important;
    }
    
    .certificate-card {
      page-break-inside: avoid;
      margin-bottom: 20px;
    }
    
    @page {
      margin: 1cm;
    }
  </style>
</body>
</html>